{% extends "base.html" %}
{% block title %}Compras{% endblock %}

{% block content %}

<style>
    @import url("https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css");

    .hidden {
        display: none;
    }

    #tableContainer {
        transition: max-height 0.5s ease;
        overflow: hidden;
        max-height: 0;
        margin-top: 10px;
        display: flex;
        flex-direction: column;
    }

    .ferramentas {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding-block: 9px;

    }

    .ativarManual {
        margin-left: 18px;
        align-self: center;
        margin-bottom: 12px;
    }

    #submitButton[disabled] {
        background-color: #ddd;
        /* Change background color */
        color: #888;
        /* Change text color */
        cursor: not-allowed;
        /* Change cursor to indicate unclickable */
        opacity: 0.6;
        /* Reduce opacity */
    }



    #filterForm input[type="radio"]:checked+label {
        text-decoration: underline;
        /* Add underline text decoration */
    }

/* Hover style for enabled button */
    .btn-dark:not(.disabled):hover {
        /* Define the hover style here */
        /* For example, change background color */
        background-color: #555 !important;
    }




    table {
        width: 100%;
    }


    table th,
    table td {
        padding: 0.4em;
    }

    table.fold-table>tbody>tr.view td,
    table.fold-table>tbody>tr.view th {
        cursor: default;


    }

    table.fold-table>tbody>tr.view td:first-child,
    table.fold-table>tbody>tr.view th:first-child {
        position: relative;
        padding-left: 20px;
    }

    table.fold-table>tbody>tr.view td:first-child:before,
    table.fold-table>tbody>tr.view th:first-child:before {
        position: absolute;
        top: 50%;
        left: 20px;
        width: 9px;
        height: 16px;
        margin-top: -8px;
        font: 16px fontawesome;
        color: #999;
        content: "▼";

        transition: all 0.3s ease;
    }

    table.fold-table>tbody>tr.view:hover {
        background: #eeeeee;
        text-decoration: underline;
    }

    table.fold-table>tbody>tr.view.open {

        background: rgb(255, 230, 129);
        color: rgb(0, 0, 0);

        font-weight: 600;
        text-decoration: underline;
    }



    table.fold-table>tbody>tr.view.open td:first-child:before,
    table.fold-table>tbody>tr.view.open th:first-child:before {
        transform-origin: right;
        transform: rotate(180deg);
        color: #000000;


    }

    table.fold-table>tbody>tr.fold {
        display: none;
    }

    table.fold-table>tbody>tr.fold.open {
        display: table-row;
        background: rgb(255, 255, 255);
    }

    table.fold-table>tbody>tr.fold.open:hover {
        background-color: rgb(255, 255, 255);
        text-decoration: none;
    }


    .fold-content {
        padding-block: 18px;
        padding-inline: 18px;

    }

    .pedido_comprasd{
        color: blue;
    }

    .valorpedido_comprasd{
        color: rgb(10, 167, 10);
        font-weight: 500;
    }

    .fold-content h3 {
        margin-top: 0;
    }

    .listaDado {
        background-color: white;
    }

    .listaDado:hover {
        background-color: rgb(221, 221, 221);
    }

    input:hover {
        cursor: pointer;
    }

    .semCompras:hover {
        background-color: white;
        text-decoration: none;
        cursor: default;
    }

    .fechado {

        background-color: rgb(241, 241, 241);
        color: rgb(153, 153, 153) !important;

    
    }

    .fechado:hover {
        text-decoration: none;
        cursor: default;
        background-color: rgb(241, 241, 241);
    }
</style>

<body>

    <div class="container">
        <div class="tabela">
            <h3 style="margin-bottom: 25px;"> Compras </h3>

            <button id="expandBtn" class="btn-cadastrar"> + Fazer Novo Pedido De Compra</button>

            <div id="tableContainer" class="hidden">


                <div class="ferramentas">
                    <form id="filterForm">
                        <input type="radio" name="filterOption" value="all" id="allOption" checked>
                        <label for="allOption">Todos</label>

                        <input type="radio" name="filterOption" value="comprar" id="comprarOption">
                        <label for="comprarOption">Comprar</label>

                        <input type="radio" name="filterOption" value="ok" id="okOption">
                        <label for="okOption">OK</label>
                    </form>

                    <div class="ativarManual">
                        <button class="btn-ferramenta" id="manualChangeBtn">Digitar Pedido</button>
                        <button class="btn-ferramenta" type="button" id="resetButton">Resetar Valores</button>
                    </div>
                </div>


                <form id="myForm" action="/salvar_compra" method="POST">
                    <div id="tableFilter">

                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all"></th>
                                    <th style="width: 5%;">codigo</th>
                                    <th>materia prima</th>
                                    <th>unidade</th>
                                    <th>estoque</th>
                                    <th style="width: 10%;">consumo medio semanal</th>
                                    <th>necessidade</th>
                                    <th>indicador</th>
                                    <th>compra minima</th>
                                   
                                    <th style="width: 20%;">pedido</th>

                                    <th>fornecedor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for estq in estoque %}
                                <tr>
                                    <td><input type="checkbox" class="select-row" name="selected_items[]"
                                            value="{{ estq.nome_mp }}"></td>
                                    <td>{{ estq.id_mp }}</td>
                                    <td style="font-weight: bolder;"><b>{{ estq.nome_mp }}</b></td>
                                    <td>{{ estq.unidade_mp }}</td>
                                    <td>{{ estq.quantidade_estq }}</td>
                                    <td>{{ estq.gms_mp }}</td>
                                    <td
                                        style="background-color: {% if estq.gms_mp - estq.quantidade_estq > 0 %}yellow; color: red; font-weight: bold;{% else %}lightgreen; color: darkgreen;{% endif %}">
                                            {% if estq.gms_mp - estq.quantidade_estq < 0 %}
                                            0.000
                                                    {% else %}
                                        {{ estq.gms_mp - estq.quantidade_estq }}
                                                        {% endif %}
                                    </td>
                                    <td
                                        style="background-color: {% if estq.gms_mp - estq.quantidade_estq > 0 %}yellow; color: red; font-weight: bold;{% else %}lightgreen; color: darkgreen;{% endif %}">
                                        {% if estq.gms_mp - estq.quantidade_estq > 0 %}
                                        Comprar
                                        {% else %}
                                        OK
                                        {% endif %}
                                    </td>
                                    <td>{{ estq.pedidomin_mp }}</td>
                                    
                                    <td>
                                        <span class="quantity">{{ estq.gms_mp - estq.quantidade_estq }}</span>
                                        <input type="number" step="0.001" name="pedido_comprasd_{{ estq.nome_mp }}"
                                            class="hidden" value="{{ estq.gms_mp - estq.quantidade_estq }}">
                                    </td>
                                    <td>
                                        <select name="fornecedores_{{ estq.nome_mp }}" class="fornecedor-select"
                                            id="fornecedores_{{ estq.nome_mp }}">
                                            <option value="" disabled selected>Seleccionar fornecedor</option>
                                            <!-- Default option -->
                                            {% if fornecedores %}
                                            {% for fornecedor in fornecedores %}
                                            <option value="{{ fornecedor.nome_fornecedor }}">{{
                                                fornecedor.nome_fornecedor }}</option>
                                            {% endfor %}
                                            {% else %}
                                            <option value="" disabled>Sem Fornecedores cadastrados</option>
                                            {% endif %}
                                        </select>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>



                        <div style="display: flex;
                            justify-content: end;
                            margin-block: 24px;
                            margin-inline: 3px;
                            height: 50px !important;">
                            <button type="submit" id="submitButton" class="btn btn-dark disabled" disabled>Fazer
                                Pedido</button>
                        </div>

                    </div>
                </form>

                    <script>
                    $(document).ready(function () {
                        // Select all checkbox functionality
                        $('#select-all').change(function () {
                            $('.select-row:visible').prop('checked', $(this).prop('checked'));
                            toggleSubmitButtonState();
                            toggleFornecedorRequired();
                        });

                        // Individual row checkbox functionality
                        $('.select-row').change(function () {
                            if ($('.select-row:checked').length === $('.select-row:visible').length) {
                                $('#select-all').prop('checked', true);
                            } else {
                                $('#select-all').prop('checked', false);
                            }

                            toggleSubmitButtonState();
                            toggleFornecedorRequired();
                        });

                        // Function to toggle submit button state based on selected rows
                        function toggleSubmitButtonState() {
                            if ($('.select-row:checked').length > 0) {
                                $('#submitButton').removeClass('disabled').prop('disabled', false);
                            } else {
                                $('#submitButton').addClass('disabled').prop('disabled', true);
                            }
                        }

                        // Function to toggle fornecedor select required attribute based on selected rows
                        function toggleFornecedorRequired() {
                            $('.select-row').each(function () {
                                var row = $(this).closest('tr');
                                var select = row.find('.fornecedor-select');
                                if ($(this).prop('checked')) {
                                    select.prop('required', true);
                                } else {
                                    select.prop('required', false);
                                }
                            });
                        }
                    });
                </script>
                s

            </div>

            <hr style="border-top: 1px solid rgba(0, 0, 0, 0.214);">

            <div class="listaCompras">

                <h4>Compras Pendentes</h4>

                <table id="myTable" class="fold-table parent-table">
                    <thead>
                        <tr>
                            <th style="width: 8%;">codigo do pedido</th>
                            <th>data do pedido</th>
                            <th style="width: 8%;">Situação</th>

                        </tr>
                    </thead>
                    <tbody class="tbody-parent">
                        {% if not comprasPendente %}
                        <tr class="semCompras">
                            <td colspan="3">
                                <h3 style="font-weight: 300; color: lightgray; margin-block: 28px;">Sem compras
                                    Pendentes</h3>
                            </td>
                        </tr>
                        {% endif %}

                        {% for comprasPendente in comprasPendente %}

                        <tr class="view">

                            <td>{{comprasPendente.id_compras}}</td>
                            <td>{{comprasPendente.data_compras | datetimeformat}}</td>
                            <td>{{comprasPendente.estado_compras}}</td>


                        </tr>
                        <tr class="fold">
                            <td colspan="3">
                                <div class="fold-content">
                                    <div class="global_ferramentas" style="display: flex; flex-direction: row;
                                    gap: 15px;">
                                        <div class="ferramentas_{{comprasPendente.id_compras}}">
                                        </div>

                                        <button class="btn-ferramenta"> Imprimir</button>

                                        <button class="btn-ferramenta" id="notaFiscal_{{comprasPendente.id_compras}}" hidden>
                                            Digitar
                                            Nota Fiscal </button>


                                    </div>



                                    <script>
                                        $(document).ready(function () {
                                            // Creating a select element
                                            var selectElement = $("<select></select>");

                                            // Reference to the table
                                            var tableId = "#tabelaComprasPendente_{{comprasPendente.id_compras}}";

                                            // Array to store unique values from the first column
                                            var uniqueValues = [];

                                            // Iterate over the table rows to extract unique values from the first column
                                            $(tableId + " tbody tr").each(function () {
                                                var firstColumnValue = $(this).find("td:eq(1)").text().trim();
                                                if (firstColumnValue && !uniqueValues.includes(firstColumnValue)) {
                                                    uniqueValues.push(firstColumnValue);
                                                }
                                            });

                                            // Append "All" option to the select element
                                            selectElement.append("<option value=''>Todos</option>");

                                            // Append options for unique values to the select element
                                            uniqueValues.forEach(function (value) {
                                                selectElement.append("<option value='" + value + "'>" + value + "</option>");
                                            });

                                            // Appending the select element to the ferramentas div
                                            $(".ferramentas_{{comprasPendente.id_compras}}").append(selectElement);

                                            // Add event listener to the select element to filter the table
                                            selectElement.change(function () {
                                                var selectedValue = $(this).val();
                                                $(tableId + " tbody tr").each(function () {
                                                    var firstColumnValue = $(this).find("td:eq(1)").text().trim();
                                                    if (selectedValue === "" || firstColumnValue === selectedValue) {
                                                        $(this).show();
                                                    } else {
                                                        $(this).hide();
                                                    }
                                                });
                                            });
                                        });
                                    </script>

                                    <form id="myForm" action="/fechar_compra" method="POST">

                                        <table id="tabelaComprasPendente_{{comprasPendente.id_compras}}" style="margin-top: 12px;">
                                            <thead>
                                                <tr>
                                                    
                                                    <th><input type="checkbox"
                                                            id="select-alldados_{{comprasPendente.id_compras}}"></th>
                                                    <th>Fornecedor</th>
                                                    <th>Departamento</th>
                                                    <th>Produto</th>
                                                    <th>Pedido</th>
                                                    <th>Unidade</th>
                                                    <th>Valor Do Pedido</th>
                                                    <th>Previsao de entrega</th>
                                                    <th>Data De Vencimento</th>
                                                    <th>Conferencia Manual</th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                {% for comprasdados in comprasdados %}
                                                {% if comprasdados.id_compras == comprasPendente.id_compras %}
                                                <tr class="listaDado {% if comprasdados.fechado_comprasd == 1 %}fechado{% endif %}" >
                                                    
                                                    <td><input type="checkbox"
                                                            class="select-rowdados_{{comprasPendente.id_compras}}"
                                                            name="selected_dados[]" value="{{ comprasdados.id_comprasd }}" {% if
                                                    comprasdados.fechado_comprasd==1 %} checked disabled {% endif %}>
                                                    </td>
                                                    <td>{{comprasdados.fornecedor_comprasd}}</td>
                                                    <td>{{comprasdados.departamento_comprasd}}</td>
                                                    <td style="font-weight: 600;">{{comprasdados.nome_mp}}</td>
                                                    <td  class="pedido_comprasd {% if comprasdados.fechado_comprasd == 1 %}fechado{% endif %}" >{{comprasdados.pedido_comprasd}}</td>
                                                    <td>{{comprasdados.unidade_mp}}</td>
                                                    <td  class="valorpedido_comprasd {% if comprasdados.fechado_comprasd == 1 %}fechado{% endif %}" >
                                                        R${{comprasdados.valorpedido_comprasd}}</td>
                                                    <td>{{comprasdados.previsao_comprasd | datetimeformat}}</td>
                                                    <td>{{comprasdados.vencimento_comprasd | datetimeformat}}</td>
                                                    <td>
                                                        <span class="notafiscal_{{comprasPendente.id_compras}}" style="text-decoration: underline;">
                                                            {% if comprasdados.fechado_comprasd == 1 %}      
                                                            Fechado
                                                            {% else %}
                                                            Conferencia Manual
                                                            {% endif %}

                                                          
                                                        </span>

                                                        <input style="width: 65%;" type="number" name="notafiscalinput_{{comprasPendente.id_compras}}"
                                                            placeholder=" DIGITAR NOTA FISCAL" {% if comprasdados.fechado_comprasd==1 %} hidden
                                                            disabled {% endif %}>
                                                    </td>
                                                </tr>
                                                
                                                <script>
                                                    $(document).ready(function () {
                                                        // Function to toggle submit button state based on selected rows
                                                        function toggleSubmitButtonDadosState() {
                                                            var selectedCount = $('.select-rowdados_{{comprasPendente.id_compras}}:checked').not(':disabled').length;
                                                             var rowCount = $("#tabelaComprasPendente_{{comprasPendente.id_compras}} tbody tr").length;
                                                            $("#submitButton_{{comprasPendente.id_compras}}").text("Fechar Pedido De Compras " + selectedCount + "/" + rowCount);

                                                            if (selectedCount > 0) {
                                                                $('#submitButton_{{comprasPendente.id_compras}}').removeClass('disabled').prop('disabled', false);
                                                            $('#submitButton_{{comprasPendente.id_compras}}').css({ 'opacity': '', 'cursor': '', 'background-color': 'black', 'color': 'white' }); // Remove disabled styles
                                                            } else {
                                                                $('#submitButton_{{comprasPendente.id_compras}}').addClass('disabled').prop('disabled', true);
                                                            $('#submitButton_{{comprasPendente.id_compras}}').css({ 'opacity': '0.5', 'cursor': 'not-allowed', 'background-color': '#ddd', 'color': '#888' });
                                                            }
                                                        }

                                                        // Select all checkbox functionality
                                                        $('#select-alldados_{{comprasPendente.id_compras}}').change(function () {
                                                            $('.select-rowdados_{{comprasPendente.id_compras}}:visible').prop('checked', $(this).prop('checked'));
                                                            toggleSubmitButtonDadosState();

                                                            // Add or remove 'required' attribute for all rows based on select all checkbox state
                                                            if ($(this).prop('checked')) {
                                                                $('input[name^="notafiscalinput_{{comprasPendente.id_compras}}"]').prop('required', true);
                                                            } else {
                                                                $('input[name^="notafiscalinput_{{comprasPendente.id_compras}}"]').prop('required', false);
                                                            }
                                                        });

                                                        // Individual row checkbox functionality
                                                        $('.select-rowdados_{{comprasPendente.id_compras}}').change(function () {
                                                            toggleSubmitButtonDadosState();

                                                            // Recalculate selectedCount whenever a checkbox is changed
                                                            var selectedCount = $('.select-rowdados_{{comprasPendente.id_compras}}:checked').not(':disabled').length;
                                                        var rowCount = $("#tabelaComprasPendente_{{comprasPendente.id_compras}} tbody tr").length;
                                                            $("#submitButton_{{comprasPendente.id_compras}}").text("Fechar Pedido De Compras " + selectedCount + "/" + rowCount);

                                                            // Add or remove 'required' attribute based on checkbox state
                                                            if ($(this).is(':checked')) {
                                                                $(this).closest('tr').find('input[name^="notafiscalinput_{{comprasPendente.id_compras}}"]').prop('required', true);
                                                            } else {
                                                                $(this).closest('tr').find('input[name^="notafiscalinput_{{comprasPendente.id_compras}}"]').prop('required', false);
                                                            }
                                                        });

                                                        // Initial calculation of rowCount and selectedCount
                                                        toggleSubmitButtonDadosState();
                                                    });

                                                </script>

                                                <script>
                                                    document.addEventListener('DOMContentLoaded', function () {
                                                        document.getElementById('notaFiscal_{{comprasPendente.id_compras}}').addEventListener('click', function () {
                                                            var compraId = "{{comprasPendente.id_compras}}";
                                                            var spans = document.querySelectorAll('.notafiscal_' + compraId);
                                                            var inputs = document.querySelectorAll('input[type="number"][name="notafiscalinput_' + compraId + '"]');
                                                            for (var i = 0; i < spans.length; i++) {
                                                                spans[i].classList.toggle('hidden');
                                                            }
                                                            for (var i = 0; i < inputs.length; i++) {
                                                                inputs[i].classList.toggle('hidden');
                                                            }
                                                        });
                                                    });
                                                </script>


                                                {% endif %}
                                                {% endfor %}

                                            </tbody>
                                        </table>



                                        <div style="display: flex;
                                                justify-content: end;
                                                margin-block: 24px;
                                                margin-inline: 3px;
                                                height: 35px !important;">
                                            <button type="submit" id="submitButton_{{comprasPendente.id_compras}}"
                                                class="btn btn-dark disabled"></button>
                                        </div>

                                    </form>






                                </div>
                            </td>
                        </tr>

                        {% endfor %}
                    </tbody>
                </table>

            </div>

            <hr>

            <div class="listaCompras">

                <h4>Compras Entregue</h4>

                <table id="myTable" class="fold-table parent-table">
                    <thead>
                        <tr>
                            <th style="width: 8%;">codigo do pedido</th>
                            <th>data do pedido</th>
                            <th style="width: 8%;">Situação</th>

                        </tr>
                    </thead>
                    <tbody class="tbody-parent">
                        {% if not comprasEntregue %}
                        <tr class="semCompras">
                            <td colspan="3">
                                <h3 style="font-weight: 300; color: rgb(189, 189, 189); margin-block: 28px;">Sem compras
                                    Fechadas</h3>
                            </td>
                        </tr>
                        {% endif %}

                        {% for comprasEntregue in comprasEntregue %}

                        <tr class="view">

                            <td>{{comprasEntregue.id_compras}}</td>
                            <td>{{comprasEntregue.data_compras | datetimeformat}}</td>
                            <td>{{comprasEntregue.estado_compras}}</td>


                        </tr>
                        <tr class="fold">
                            <td colspan="3">
                                <div class="fold-content">
                                    <div class="global_ferramentas" style="display: flex; flex-direction: row;
                                    gap: 15px;">
                                        <div class="ferramentasFechados_{{comprasEntregue.id_compras}}">
                                        </div>

                                        <button class="btn-ferramenta"> Imprimir</button>



                                    </div>



                                    <script>
                                        $(document).ready(function () {
                                            // Creating a select element
                                            var selectElement = $("<select></select>");

                                            // Reference to the table
                                            var tableId = "#tabelaComprasFechadas_{{comprasEntregue.id_compras}}";

                                            // Array to store unique values from the first column
                                            var uniqueValues = [];

                                            // Iterate over the table rows to extract unique values from the first column
                                            $(tableId + " tbody tr").each(function () {
                                                var firstColumnValue = $(this).find("td:eq(1)").text().trim();
                                                if (firstColumnValue && !uniqueValues.includes(firstColumnValue)) {
                                                    uniqueValues.push(firstColumnValue);
                                                }
                                            });

                                            // Append "All" option to the select element
                                            selectElement.append("<option value=''>Todos</option>");

                                            // Append options for unique values to the select element
                                            uniqueValues.forEach(function (value) {
                                                selectElement.append("<option value='" + value + "'>" + value + "</option>");
                                            });

                                            // Appending the select element to the ferramentas div
                                            $(".ferramentasFechados_{{comprasEntregue.id_compras}}").append(selectElement);

                                            // Add event listener to the select element to filter the table
                                            selectElement.change(function () {
                                                var selectedValue = $(this).val();
                                                $(tableId + " tbody tr").each(function () {
                                                    var firstColumnValue = $(this).find("td:eq(1)").text().trim();
                                                    if (selectedValue === "" || firstColumnValue === selectedValue) {
                                                        $(this).show();
                                                    } else {
                                                        $(this).hide();
                                                    }
                                                });
                                            });
                                        });
                                    </script>

                                    <form id="myForm" action="/fechar_compra" method="POST">

                                        <table id="tabelaComprasFechadas_{{comprasEntregue.id_compras}}" style="margin-top: 12px;">
                                            <thead>
                                                <tr>
                                                    
                                                    <th><input type="checkbox"
                                                            id="select-alldados_{{comprasEntregue.id_compras}}"></th>
                                                    <th>Fornecedor</th>
                                                    <th>Departamento</th>
                                                    <th>Produto</th>
                                                    <th>Pedido</th>
                                                    <th>Unidade</th>
                                                    <th>Valor Do Pedido</th>
                                                    <th>Previsao de entrega</th>
                                                    <th>Data De Vencimento</th>
                                                    <th>Conferencia Manual</th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                {% for comprasdados in comprasdados %}
                                                {% if comprasdados.id_compras == comprasEntregue.id_compras %}
                                                <tr class="listaDado {% if comprasdados.fechado_comprasd == 1 %}fechado{% endif %}" >
                                                    
                                                    <td><input type="checkbox"
                                                            class="select-rowdados_{{comprasEntregue.id_compras}}"
                                                            name="selected_dados[]" value="{{ comprasdados.id_comprasd }}" {% if
                                                    comprasdados.fechado_comprasd==1 %} checked disabled {% endif %}>
                                                    </td>
                                                    <td>{{comprasdados.fornecedor_comprasd}}</td>
                                                    <td>{{comprasdados.departamento_comprasd}}</td>
                                                    <td style="font-weight: 600;">{{comprasdados.nome_mp}}</td>
                                                    <td  class="pedido_comprasd {% if comprasdados.fechado_comprasd == 1 %}fechado{% endif %}" >{{comprasdados.pedido_comprasd}}</td>
                                                    <td>{{comprasdados.unidade_mp}}</td>
                                                    <td  class="valorpedido_comprasd {% if comprasdados.fechado_comprasd == 1 %}fechado{% endif %}" >
                                                        R${{comprasdados.valorpedido_comprasd}}</td>
                                                    <td>{{comprasdados.previsao_comprasd | datetimeformat}}</td>
                                                    <td>{{comprasdados.vencimento_comprasd | datetimeformat}}</td>
                                                    <td>
                                                        <span class="notafiscal_{{comprasEntregue.id_compras}}" style="text-decoration: underline;">
                                                            {% if comprasdados.fechado_comprasd == 1 %}      
                                                            Fechado
                                                            {% else %}
                                                            Conferencia Manual
                                                            {% endif %}

                                                          
                                                        </span>

                                                        
                                                    </td>
                                                </tr>
                                                
                                                <script>
                                                    $(document).ready(function () {
                                                        // Function to toggle submit button state based on selected rows
                                                        

                                                        // Select all checkbox functionality
                                                        $('#select-alldados_{{comprasEntregue.id_compras}}').change(function () {
                                                            $('.select-rowdados_{{comprasEntregue.id_compras}}:visible').prop('checked', $(this).prop('checked'));
                                                            toggleSubmitButtonDadosState();

                                                        
                                                        });

                                                        // Individual row checkbox functionality
                                                        $('.select-rowdados_{{comprasEntregue.id_compras}}').change(function () {
                                                            toggleSubmitButtonDadosState();

                                                            // Recalculate selectedCount whenever a checkbox is changed
                                                            var selectedCount = $('.select-rowdados_{{comprasEntregue.id_compras}}:checked').not(':disabled').length;
                                                            var rowCount = $("#tabelaComprasFechadas_{{comprasEntregue.id_compras}} tbody tr").length;
                                                          

                                                        });

                                                        // Initial calculation of rowCount and selectedCount
                                                        toggleSubmitButtonDadosState();
                                                    });

                                                </script>

                                                <script>
                                                    document.addEventListener('DOMContentLoaded', function () {
                                                        document.getElementById('notaFiscal_{{comprasEntregue.id_compras}}').addEventListener('click', function () {
                                                            var compraId = "{{comprasEntregue.id_compras}}";
                                                            var spans = document.querySelectorAll('.notafiscal_' + compraId);
                                                            var inputs = document.querySelectorAll('input[type="number"][name="notafiscalinput_' + compraId + '"]');
                                                            for (var i = 0; i < spans.length; i++) {
                                                                spans[i].classList.toggle('hidden');
                                                            }
                                                            for (var i = 0; i < inputs.length; i++) {
                                                                inputs[i].classList.toggle('hidden');
                                                            }
                                                        });
                                                    });
                                                </script>


                                                {% endif %}
                                                {% endfor %}

                                            </tbody>
                                        </table>


                                    </form>






                                </div>
                            </td>
                        </tr>

                        {% endfor %}
                    </tbody>
                </table>

            </div>
            <br>
        </div>
    </div>

</body>



<script>
    $(function () {
        $(".fold-table tr.view").on("click", function () {
            // Close all other open rows
            $(".fold-table tr.view").not(this).removeClass("open");
            $(".fold-table tr.fold.open").not($(this).next(".fold")).removeClass("open");

            // Toggle the class for the clicked row and its corresponding fold
            $(this).toggleClass("open");
            $(this).next(".fold").toggleClass("open");

            // Get the target component relative to the clicked row
            const targetElement = $(this).next(".fold").find(".target-component");

            // Scroll to the target component
            scrollToComponent(targetElement);
        });
    });

    function scrollToComponent(targetElement) {
        // Calculate the target scroll position
        // Adjust this value to set the space at the top
        const offset = 40;
        const targetScrollPosition = targetElement.offset().top - offset;

        // Scroll to the target position
        window.scrollTo({
            top: targetScrollPosition,
            behavior: 'smooth' // Optional: Use smooth scrolling
        });
    }
</script>

<script>
    // jQuery code for filtering the table
    $(document).ready(function () {
        // Add event listener for form changes
        $('#filterForm input[type="radio"]').change(filterTable);

        function filterTable() {
            // Get the selected filter option
            var selectedOption = $('#filterForm input[name="filterOption"]:checked').val();

            // Get the table rows
            var rows = $('#tableFilter table tbody tr');

            // Loop through all table rows
            rows.each(function () {
                // Get the cell containing the indicator text
                var cell = $(this).find('td:eq(7)'); // Adjust index as needed

                // Get the indicator text content and convert to lowercase
                var indicatorText = cell.text().trim().toLowerCase();

                // Show or hide rows based on the selected filter option
                if (selectedOption === 'all' || indicatorText === selectedOption) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });
</script>



<script>
    document.getElementById('manualChangeBtn').addEventListener('click', function () {
        var spans = document.querySelectorAll('.quantity');
        var inputs = document.querySelectorAll('input[type="number"]');
        var submitButton = document.getElementById('submitButton');
        var selects = document.getElementById('fornecedores'); // Get all select elements with name "fornecedores"
        for (var i = 0; i < spans.length; i++) {
            spans[i].classList.toggle('hidden');
        }
        for (var i = 0; i < inputs.length; i++) {
            inputs[i].classList.toggle('hidden');
        }
        /*submitButton.classList.toggle('hidden');*/

        // Toggle the disabled attribute of all select elements
        selects.forEach(function (select) {
            if (select.options.length > 0) {
                select.disabled = !select.disabled;
            }
        });
    });
</script>

<script>
    document.getElementById("expandBtn").addEventListener("click", function () {
        var tableContainer = document.getElementById("tableContainer");
        if (tableContainer.classList.contains("hidden")) {
            tableContainer.classList.remove("hidden");
            setTimeout(function () {
                tableContainer.style.maxHeight = tableContainer.scrollHeight + "px";
            }, 10);
        } else {
            tableContainer.style.maxHeight = null;
            tableContainer.classList.add("hidden");
        }
    });
</script>

<script>
    document.getElementById('resetButton').addEventListener('click', function () {
        document.getElementById('myForm').reset(); // Reset the form
    });
</script>

<!-- Bootstrap JS -->
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


{% endblock %}